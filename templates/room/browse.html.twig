{% extends 'base.html.twig' %}

{% block title %}Available Chat Rooms{% endblock %}

{% block content %}
    <style>
        .room-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: none;
            border-radius: 12px;
            overflow: hidden;
        }

        .room-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .room-card .card-body {
            padding: 1.5rem;
        }

        .badge-status {
            font-size: 0.75rem;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
        }

        .room-info {
            display: flex;
            align-items: center;
            margin: 0.5rem 0;
            color: #6c757d;
            font-size: 0.9rem;
        }

        .room-info i {
            width: 20px;
            margin-right: 8px;
        }

        .btn-join {
            border-radius: 8px;
            padding: 0.6rem 1.2rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-join:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .filter-section {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 2rem;
        }

        .page-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
        }

        .page-header h2 {
            margin: 0;
            font-weight: 600;
        }

        .btn-create {
            background: white;
            color: #667eea;
            border: none;
            padding: 0.6rem 1.5rem;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-create:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255,255,255,0.3);
            color: #667eea;
            background: #f8f9fa;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .modal-content {
            border-radius: 15px;
            border: none;
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0;
        }

        .modal-header .btn-close {
            filter: brightness(0) invert(1);
        }
    </style>

    <div class="container-fluid py-4" id="room-page">
        <div class="page-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="fas fa-comments me-2"></i>Available Chat Rooms</h2>
                    <p class="mb-0 mt-2 opacity-75">Join a conversation or create your own room</p>
                </div>
                <button class="btn btn-create" id="btn-open-modal">
                    <i class="fas fa-plus me-2"></i>Create Room
                </button>
            </div>
        </div>

        <div class="filter-section">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <label class="form-label fw-bold"><i class="fas fa-filter me-2"></i>Filter by Language</label>
                    <select id="filter-language" class="form-select">
                        <option value="">All Languages</option>
                    </select>
                </div>
                <div class="col-md-8 text-end">
                    <span class="text-muted" id="rooms-count">Loading rooms...</span>
                </div>
            </div>
        </div>

        <div id="rooms" class="row g-4"></div>
    </div>

    <!-- Create Room Modal -->
    <div class="modal fade" id="createRoomModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <form id="create-room-form">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="fas fa-door-open me-2"></i>Create a New Room</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Topic</label>
                            <select class="form-select" name="topic" id="topic-select" required>
                                <option value="">Select a topic...</option>
                                {% for topic in topics %}
                                    <option value="{{ topic.id }}">{{ topic.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Language</label>
                            <select class="form-select" name="targetLanguage" id="language-select" required>
                                <option value="">Select a language...</option>
                                {% for language in languages %}
                                    <option value="{{ language.id }}">{{ language.name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Proficiency Level</label>
                            <select class="form-select" name="proficiencyLevel" id="level-select" required>
                                <option value="">Select a level...</option>
                                {% for level in proficiencyLevels %}
                                    <option value="{{ level.id }}">{{ level.levelName }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Max Participants</label>
                                <input type="number" class="form-control" name="maxParticipants" min="2" max="20" value="5" required />
                            </div>

                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Duration (minutes)</label>
                                <select class="form-select" name="durationMinutes">
                                    <option value="15">15</option>
                                    <option value="30" selected>30</option>
                                    <option value="45">45</option>
                                    <option value="60">60</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Scheduled Time</label>
                            <input type="datetime-local" class="form-control" name="scheduledTime" required />
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Cancel</button>
                        <button class="btn btn-primary" type="submit">
                            <i class="fas fa-check me-2"></i>Create Room
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        const roomsEl = document.getElementById('rooms');
        const langFilterEl = document.getElementById('filter-language');
        const roomsCountEl = document.getElementById('rooms-count');
        const modalEl = document.getElementById('createRoomModal');
        const openBtn = document.getElementById('btn-open-modal');
        const formEl = document.getElementById('create-room-form');
        let allRooms = [];

        function renderRooms(rooms) {
            roomsEl.innerHTML = '';

            if (!rooms.length) {
                roomsEl.innerHTML = `
      <div class="col-12">
        <div class="empty-state">
          <i class="fas fa-inbox"></i>
          <h4>No rooms available</h4>
          <p class="text-muted">Be the first to create a conversation room!</p>
        </div>
      </div>`;
                roomsCountEl.textContent = 'No rooms available';
                return;
            }

            roomsCountEl.textContent = `${rooms.length} room${rooms.length !== 1 ? 's' : ''} available`;

            rooms.forEach(r => {
                const participantsCount = (r.participants || []).length;
                const spotsLeft = (r.maxParticipants || 0) - participantsCount;
                const timeUntil = timeUntilStart(r.scheduledTime);
                const disabled = spotsLeft <= 0 ? 'disabled' : '';
                const statusClass = r.status === 'available' ? 'bg-success' : (r.status === 'occupied' ? 'bg-warning' : 'bg-secondary');
                const statusIcon = r.status === 'available' ? 'fa-check-circle' : (r.status === 'occupied' ? 'fa-users' : 'fa-times-circle');

                // Get display names from relationships
                const topicName = r.topic?.name || 'Untitled Room';
                const languageName = r.targetLanguage?.name || 'N/A';
                const levelName = r.proficiencyLevel?.levelName || 'N/A';

                const card = document.createElement('div');
                card.className = 'col-md-6 col-lg-4';
                card.innerHTML = `
      <div class="card room-card h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-3">
            <h5 class="card-title mb-0 flex-grow-1">${escapeHtml(topicName)}</h5>
            <span class="badge badge-status ${statusClass}">
              <i class="fas ${statusIcon} me-1"></i>${escapeHtml(r.status || 'Unknown')}
            </span>
          </div>

          <div class="room-info">
            <i class="fas fa-language"></i>
            <span><strong>Language:</strong> ${escapeHtml(languageName)}</span>
          </div>

          <div class="room-info">
            <i class="fas fa-signal"></i>
            <span><strong>Level:</strong> ${escapeHtml(levelName)}</span>
          </div>

          <div class="room-info">
            <i class="fas fa-users"></i>
            <span><strong>Participants:</strong> ${participantsCount}/${r.maxParticipants || 0}</span>
          </div>

          <div class="room-info">
            <i class="fas fa-clock"></i>
            <span><strong>Starts in:</strong> ${timeUntil}</span>
          </div>

          <div class="mt-3">
            <a class="btn btn-primary btn-join w-100 ${disabled}" href="/room/${r.id}" ${disabled ? 'aria-disabled="true"' : ''}>
              <i class="fas ${spotsLeft <= 0 ? 'fa-lock' : 'fa-sign-in-alt'} me-2"></i>
              ${spotsLeft <= 0 ? 'Room Full' : 'Join Room'}
            </a>
          </div>
        </div>
      </div>`;
                roomsEl.appendChild(card);
            });
        }

        function escapeHtml(str) {
            return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[s]));
        }

        function timeUntilStart(iso) {
            if (!iso) return '-';
            const now = new Date();
            const scheduled = new Date(iso);
            const diff = scheduled.getTime() - now.getTime();
            if (Number.isNaN(diff)) return '-';
            if (diff < 0) return 'Started';
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            if (days > 0) return `${days}d ${hours % 24}h`;
            if (hours > 0) return `${hours}h ${minutes % 60}m`;
            return `${minutes}m`;
        }

        async function loadRooms() {
            try {
                const res = await fetch('/api/rooms/available');
                if (!res.ok) throw new Error('Failed to load rooms');
                allRooms = await res.json();

                // Extract unique languages from rooms for filter
                const langs = Array.from(new Set(
                    allRooms
                        .map(r => r.targetLanguage?.name)
                        .filter(Boolean)
                )).sort();

                langFilterEl.innerHTML = '<option value="">All Languages</option>' +
                    langs.map(l => `<option value="${escapeHtml(l)}">${escapeHtml(l)}</option>`).join('');

                applyFilter();
            } catch (e) {
                console.error(e);
                roomsCountEl.textContent = 'Error loading rooms';
                roomsEl.innerHTML = `
      <div class="col-12">
        <div class="alert alert-danger">
          <i class="fas fa-exclamation-triangle me-2"></i>
          Failed to load rooms. Please try again later.
        </div>
      </div>`;
            }
        }

        function applyFilter() {
            const selected = langFilterEl.value || '';
            const filtered = selected
                ? allRooms.filter(r => r.targetLanguage?.name === selected)
                : allRooms;
            renderRooms(filtered);
        }

        langFilterEl.addEventListener('change', applyFilter);

        const bsModal = new bootstrap.Modal(modalEl);
        openBtn.addEventListener('click', () => {
            const dt = new Date();
            dt.setMinutes(dt.getMinutes() + 5);
            const local = dt.toISOString().slice(0, 16);
            formEl.elements['scheduledTime'].value = local;
            bsModal.show();
        });

        formEl.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = formEl.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creating...';

            const formData = new FormData(formEl);
            const payload = Object.fromEntries(formData.entries());

            // Convert to proper types and IDs
            payload.topic = Number(payload.topic);
            payload.targetLanguage = Number(payload.targetLanguage);
            payload.proficiencyLevel = Number(payload.proficiencyLevel);
            payload.maxParticipants = Number(payload.maxParticipants);
            payload.durationMinutes = Number(payload.durationMinutes);

            try {
                const res = await fetch('/api/rooms/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!res.ok) {
                    const err = await res.json().catch(() => ({}));
                    alert(err.error || 'Failed to create room');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                    return;
                }

                const created = await res.json();
                bsModal.hide();
                window.location.href = `/room/${created.id}`;
            } catch (e) {
                console.error(e);
                alert('Error creating room');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        });

        loadRooms();
        setInterval(loadRooms, 10000);
    </script>
{% endblock %}